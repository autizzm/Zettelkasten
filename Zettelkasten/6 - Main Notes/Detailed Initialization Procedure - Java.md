
12-09-2025 09:46

Status: #child 

Tags: [[Java Core]] [[Under the hood - Java]]

---
# Detailed Initialization Procedure - Java

(JLS §12.4.2) [Link to JLS](https://docs.oracle.com/javase/specs/jls/se21/html/jls-12.html#jls-12.4.2)


 ==Класс инициализируется **лениво**== – при первом активном использовании (например, доступ к статическому полю, вызов статического метода, создание экземпляра).


> [!warning]
> - `static final` **с compile-time constant expression** → получают значение сразу, без инициализации класса.
> 
> - Остальные `static`/`static final` → сначала **default value** на этапе **Preparation**, потом реальное значение при **Initialization**.


> [!note]
> Есть промежуток времени, когда ~={orange}через рефлексию=~ можно получить ~={orange}default-value=~ переменной, заданной как static final 
> (если она не задана литералом или простым арифметическим действием) 


~={red}!!!!=~ ~={yellow}Значения константам присваиваются на этапе компиляции=~ ~={red}!!!!



> [!warning] **Что выполняется при инициализации**
> При инициализации выполняются **только** static initializer blocks.


Первоначально, потоки синхронизируются, чтобы класс загружался только одним ClassLoader-ом.

## Загрузка класса/интерфейса

1. **Loading (загрузка)**: поиск и загрузка бинарного представления класса.
	- Когда JVM загружает класс или интерфейс, его **method signatures (включая default/static методы)** уже попадают в Metaspace.
	
2. **Linking (связывание)**:
	- **Verification** – проверка байткода.
        
    - **Preparation** – выделение памяти под статические поля и присвоение им **default values** (0, null, false и т. д.).
        
    - **Resolution** – связывание ссылок на другие классы.
        
3. **Initialization** – выполнение [[clinit method - Java|<clinit>]] (Не только, подробнее [[Detailed Initialization Procedure - Java#Процесс инициализации|здесь]]).


## Процесс инициализации

1. **Инициализация зависимостей** – ==рекурсивно инициализировать суперкласс и все суперинтерфейсы с default-методами==. Если у них ошибка — пометить текущий класс как ошибочный и пробросить исключение.  
	
2. **Определение режима [[assert Java|assert]]** – проверка, включены ли утверждения для класса. 
	- Это нужно, потому что `assert` зависит от **ClassLoader**:
	    - каждый `ClassLoader` может иметь **свои правила включения/выключения assert**;
	    - например, одни классы можно грузить с включёнными проверками, другие — без.
	        
	- Для этого JVM спрашивает у `ClassLoader`, какие параметры assertion установлены.
	
3. **Выполнение [[Initializer; constants & just static finals - Java|инициализаторов]]** – выполнить статические поля и блоки инициализации (для интерфейса — инициализаторы полей).  ([[clinit method - Java|метод <clinit>]])
	
4. **Успешное завершение** – отметить класс как полностью инициализированный и разбудить ожидающие потоки.  
	
5. **Если в инициализаторах выброшено исключение** – обернуть в `ExceptionInInitializerError` (если это не `Error`) или заменить на `OutOfMemoryError` при нехватке памяти.  
	-  **Ошибка инициализации** – отметить класс как ошибочный, уведомить ожидающие потоки и завершить с этим исключением.



----
#### [[Detailed Initialization Procedure - Java - Flashcards|Link to flashcards]]



---
### References:

- [[Жизненный цикл класса Java]]
- [[clinit method - Java]]
- [[assert Java]]