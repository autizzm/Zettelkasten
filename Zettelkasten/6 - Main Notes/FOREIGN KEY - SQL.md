
17-09-2025 16:59

Status: #child

Tags: [[SQL]]

---
# FOREIGN KEY - SQL


![[Pasted image 20251026134830.png]]


Синтаксис:
```sql
FOREIGN KEY (<column_1>, <column_n>)
REFERENCES <external_table> (<external_table_column_1>, <external_table_column_n>)
[ON DELETE reference_option]
[ON UPDATE reference_option]
```


> [!note] 
> При вставке значений в Child таблицу (содержащую FOREIGN KEY), если соответствующего значения поля FOREIGN KEY нет в Parent таблице -> error, значение не всатвляется.
> ```sql
> CREATE TABLE Director(
> 	director_id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
> 	...
> ) -- Например, максимальное значение director_id = 10
>
>CREATE TABLE Movie(
>	...
>	director_id REFERENCES Director(director_id)
>)
>
>-- ошибка, т.к. в Director нет такого значения в колонке director_id
>INSERT INTO Director (..., director_id) VALUES (..., 11);
> ```


Пример использования:
```sql
CREATE TABLE Users (
    id INTEGER,
    name VARCHAR(255) NOT NULL,
    age INTEGER NOT NULL DEFAULT 18,
    company INTEGER,
    PRIMARY KEY (id),
    FOREIGN KEY (company) REFERENCES Companies (id)
    ON DELETE RESTRICT ON UPDATE CASCADE
);
```

Вариант синтаксиса:
```sql
CREATE TABLE fct_transactions (
    transaction_id SERIAL,
    product_id INT REFERENCES dim_products(product_id),
    employee_id INT REFERENCES dim_employees(employee_id),
    store_id INT REFERENCES dim_stores(store_id),
    customer_id INT REFERENCES dim_customers(customer_id),
    total_purchase_price REAL

);
```

---

### Каскадирование

Possible options for ~={cyan}ON DELETE=~ and ~={cyan}ON UPDATE=~:

- ~={cyan}CASCADE=~ — automatically deletes or updates related records
- ~={cyan}SET NULL=~ — sets NULL for the foreign key
- ~={cyan}SET DEFAULT=~ — sets the default value
- ~={cyan}RESTRICT=~ — prevents deletion or update (used by default)
- ~={cyan}NO ACTION=~ — similar to RESTRICT in most DBMSs

> [!warning]
> По умолчанию для FOREIGN KEY - ON DELETE RESTRICT.

~={cyan}ON DELETE RESTRICT=~ - значит, что, если попробовать удалить запись о компании из таблицы Companies (удалить id компании) И ПРИ ЭТОМ в таблице Users будут записи, ссылающиеся на эту компанию (хранящие в поле company id этой компании) -> ~={orange}БД выдаст ошибку:=~
```sql
Cannot delete or update a parent row: a foreign key constraint fails
```
**TL;DR:**
	Удаление [[DB Relationships#Кто Parent, а кто Child|Parent]] записи -> error, если на нееё ссылается хоть один [[DB Relationships#Кто Parent, а кто Child|Child]]


~={cyan}ON DELETE CASCADE=~ - значит, если попробовать удалить запись о компании из таблицы Companies (удалить id компании) И ПРИ ЭТОМ в таблице Users будут записи, ссылающиеся на эту компанию (хранящие в поле company id этой компании) -> ~={orange}БД удалит эти записи из таблицы Users=~
**TL;DR:**
	Удаление Parent записи -> удаление Child записей, ссылающихся на неё



~={cyan}ON DELETE SET NULL=~ - значит, если попробовать удалить запись о компании из таблицы Companies (удалить id компании) И ПРИ ЭТОМ в таблице Users будут записи, ссылающиеся на эту компанию (хранящие в поле company id этой компании) -> БД установит в поле company значение NULL  для этих записей в таблице Users 
**TL;DR:**
	Удаление Parent записи -> у Child записей поле FOREIGN KEY станет NULL



~={cyan}ON UPDATE CASCADE=~ - значит, ~={orange}если обновляется запись о компании в таблице Companies=~, то все ~={orange}записи =~о пользователях~={orange} из=~ таблицы ~={orange}User=~, содержащих id этой компании, ~={orange}будут обновлены=~ (если поменялся id - он изменится и в поле company соотвтетсвующих записей таблицы Users)
**TL;DR:**
	Если у Parent записи меняется id -> в Child записи будет обновлено поле с этим FOREIGN KEY.


> [!note] **Обобщение**
> Все эти правила триггерятся при изменении/удалении записи другой таблицы (чей id мы храним)


----
#### [[FOREIGN KEY - SQL - Flashcards|Link to flashcards]]



---
### References:

